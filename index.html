<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaderboard</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <nav><a href="backend/datamanagement.html">Data Management</a></nav>
    <h1>Welcome to the Game, enter your name to begin!</h1>
    <p>Some basics:</p>
    <p>You can wall jump by touching a wall and pressing space again!</p>
    <p>
      Picking up coins will help make sure the timer stays high enough for your
      to complete future levels!
    </p>

    <!-- Name Input Form -->
    <form id="nameForm">
      <label for="playerName">Enter your name:</label>
      <input type="text" id="playerName" required />
      <button type="submit">Start Game</button>
    </form>

    <h2>Leaderboard</h2>
    <div id="leaderboard"></div>

    <script>
      // Store player name in localStorage and check for duplicate
      document
        .getElementById("nameForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent page reload

          const playerName = document.getElementById("playerName").value;
          if (!playerName) return;

          try {
            // Fetch existing leaderboard data
            const response = await fetch(
              `./data.json?cache-bust=${new Date().getTime()}`,
              {
                cache: "no-store",
              }
            );

            const data = await response.json();

            // Check if the entered name already exists in the leaderboard
            const nameExists = data.some(
              (entry) => entry.name.toLowerCase() === playerName.toLowerCase()
            );

            if (nameExists) {
              alert(
                "This name is already taken. Please choose a different name."
              );
            } else {
              // Save player name and redirect
              localStorage.setItem("playerName", playerName);
              window.location.href = "javascript_game/scriptgame.html"; // Redirect to the game page
            }
          } catch (error) {
            console.error("Failed to fetch leaderboard data:", error);
            alert(
              "An error occurred while checking the leaderboard. Please try again."
            );
          }
        });

      async function fetchLeaderboard() {
        try {
          console.log("Fetching leaderboard");
          const response = await fetch(
            `./data.json?cache-bust=${new Date().getTime()}`,
            {
              cache: "no-store",
            }
          );
          const data = await response.json();

          // Sort and display top scores
          const sortedData = data
            .sort((a, b) => b.coins * b.levels - a.coins * a.levels)
            .slice(0, 5); // Display top 5 players

          const leaderboard = document.getElementById("leaderboard");
          leaderboard.innerHTML = sortedData
            .map(
              (entry, index) =>
                `<p>${index + 1}. ${entry.name}: [ score: ${
                  entry.coins + entry.levels
                }. ] ${entry.coins} coins, ${entry.levels} levels completed</p>`
            )
            .join("");
        } catch (error) {
          console.error("Failed to fetch leaderboard data:", error);
          document.getElementById("leaderboard").innerHTML =
            "<p>Failed to load leaderboard data.</p>";
        }
      }

      // Fetch leaderboard data on page load
      window.onload = fetchLeaderboard;

      // Refresh leaderboard every 5 seconds
      setInterval(fetchLeaderboard, 5000);
    </script>
  </body>
</html>
